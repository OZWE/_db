function notifyChange(e){e.closest("form").addClass("dirty");$("#btnSave").addClass("dirty")}function updatePreviewContents(){$("#previewContents>div").html('<img src="/i/loading.gif" class="loading" />');$.getJSON("index.php",{f:"getStructure",dir:$("header form select[name=dir]").val()},function(e){var t,n,r,i;console.log(e.data);t="";for(n=0;n<e.data.length;n++){t+='<a href="#c'+n+'"><h2>'+e.data[n].title+"</h2>";r=e.data[n].p.length;for(i=0;i<r;i++){console.log("text:"+e.data[n].p[i].text);t+='<p class="'+e.data[n].p[i].type+'">'+e.data[n].p[i].text+"</p>"}t+="</a>"}$("#previewContents>div").html(t);$("#previewContents a").click(function(){$("#previewContents").fadeOut()})})}function structureChanged(){$(".pSepTarget.section").each(function(e){$(this).attr("id","c"+e)});updatePreviewContents()}function save(e,t){var n=e.serialize();$.post("?save=",n,function(){t!==undefined&&t.apply(this,arguments)});return!1}function saveAll(){$("form.dirty").each(function(){save($(this),function(){structureChanged()});$(this).removeClass("dirty")});$("#btnSave").removeClass("dirty")}function keepAlive(){$.get("index.php",{f:"keepAlive"})}function setDragTarget(e,t){clearTimeout(lockDragTargetTimer);t.stop(!1,!0);e?t.addClass("targetLocked",kDragLockAnimDuration):t.removeClass("targetLocked",kDragLockAnimDuration)}function initDroppables(){$(".pSepTarget.ui-droppable").droppable("destroy");$(".pSepTarget.continue").droppable({accept:$(".separator"),drop:function(e,t){var n=t.helper.data("type");t.helper.remove();$(this).addClass(n,kDragLockAnimDuration);$(this).find("input[name=chaptering]").val(n);$(this).droppable("disable");structureChanged();notifyChange($(this))},over:function(e,t){lockDragTargetTimer=setTimeout(function(){setDragTarget(!0,t.helper)},kDragLockDelay)},out:function(e,t){setDragTarget(!1,t.helper)}})}function removeSeparator(e){var t=e.parent(".pSepTarget");t.find("input[name=section_title]").val("");t.find("input[name=chaptering]").val("continue");t.removeClass("section paragraph",kRemoveAnimationDuration).addClass("continue",kRemoveAnimationDuration);notifyChange(t);initDroppables()}var lockDragTargetTimer,kDragLockDelay,kDragLockAnimDuration,kRemoveAnimationDuration,kKeepAliveInterval=12e4;lockDragTargetTimer=null;kDragLockDelay=400;kDragLockAnimDuration=200;kRemoveAnimationDuration=300;$(document).ready(function(){$("#tools .separator").draggable({axis:"y",helper:"clone",revert:"invalid",scroll:!0,snap:".pSepTarget.continue",snapMode:"inner",snapTolerance:20});initDroppables();$(".pSepTarget>img").click(function(){removeSeparator($(this))});$("input,textarea").bind("input",function(){notifyChange($(this))});$("#btnSave").click(function(){saveAll()});$("#btnPreviewContents").click(function(){$("#previewContents").fadeToggle("fast")});structureChanged();setInterval(function(){keepAlive()},kKeepAliveInterval)});